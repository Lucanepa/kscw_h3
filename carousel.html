<!DOCTYPE html>
<html lang="en">
<body>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="kscw_trio.png" />
    <style>
      :root { --gap: 12px; --radius: 14px; }
      body { 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; 
        margin: 0; 
        background: #0b1020; 
        color: #f1f5f9;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      header { 
        padding: 18px 16px; 
        display: flex; 
        gap: var(--gap); 
        align-items: center; 
        justify-content: center; 
        border-bottom: 1px solid #223; 
        background: rgba(11,16,32,.65);
      }
      
      h1 { font-size: 24px; margin: 0; letter-spacing: .3px; text-align: center; }
      
      .carousel-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
      }
      
      .carousel {
        position: relative;
        max-width: 800px;
        width: 100%;
        height: 500px;
        overflow: hidden;
        border-radius: var(--radius);
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      }
      
      .carousel-inner {
        display: flex;
        transition: transform 0.5s ease-in-out;
        height: 100%;
      }
      
      .carousel-item {
        min-width: 100%;
        height: 100%;
        position: relative;
      }
      
      .carousel-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 500px;
        font-size: 18px;
        color: #94a3b8;
      }
      
      .error {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 500px;
        font-size: 18px;
        color: #ef4444;
        text-align: center;
      }
    </style>
  <div class="carousel-container">
    <div id="loading" class="loading">
      Loading images...
    </div>
    
    <div id="error" class="error hidden">
      Failed to load images. Please check the console for details.
    </div>
    
    <div id="carousel" class="carousel hidden">
      <div class="carousel-inner" id="carouselInner"></div>
    </div>
  </div>

  <!-- Supabase JS v2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    let supabase;
    let images = [];
    let currentIndex = 0;
    let autoPlayInterval;

    const el = (id) => document.getElementById(id)
    const carouselInner = el('carouselInner')

    async function initCarousel() {
      try {
        supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey)
        
        // Load images from bucket
        const { data, error } = await supabase.storage.from(SUPABASE_CONFIG.bucket).list('', {
          sortBy: { column: 'updated_at', order: 'desc' }
        })
        
        if (error) throw error
        
        images = data.filter(file => file.name && file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i))
        
        if (images.length === 0) {
          showError('No images found in the bucket')
          return
        }
        
        // Randomize images
        images = shuffleArray(images)
        
        await loadImages()
        setupCarousel()
        startAutoPlay()
        
      } catch (error) {
        console.error('Error loading images:', error)
        showError('Failed to load images: ' + error.message)
      }
    }

    function shuffleArray(array) {
      const shuffled = [...array]
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
      }
      return shuffled
    }

    async function loadImages() {
      for (let i = 0; i < images.length; i++) {
        const image = images[i]
        let url
        
        try {
          // Try signed URL first
          const { data: signedData, error: signedError } = await supabase.storage
            .from(SUPABASE_CONFIG.bucket)
            .createSignedUrl(image.name, 60 * 60 * 24) // 24 hours
          
          if (!signedError && signedData) {
            url = signedData.signedUrl
          } else {
            // Fallback to public URL
            const { data } = supabase.storage.from(SUPABASE_CONFIG.bucket).getPublicUrl(image.name)
            url = data.publicUrl
          }
          
          // Create carousel item
          const item = document.createElement('div')
          item.className = 'carousel-item'
          item.innerHTML = `<img src="${url}" alt="${image.name}" loading="lazy" />`
          carouselInner.appendChild(item)
          
        } catch (error) {
          console.error('Error loading image:', image.name, error)
        }
      }
    }

    function setupCarousel() {
      el('loading').classList.add('hidden')
      el('carousel').classList.remove('hidden')
    }

    function startAutoPlay() {
      if (autoPlayInterval) clearInterval(autoPlayInterval)
      autoPlayInterval = setInterval(() => {
        currentIndex = (currentIndex + 1) % images.length
        carouselInner.style.transform = `translateX(-${currentIndex * 100}%)`
      }, 3000) // 3 seconds per slide
    }

    function showError(message) {
      el('loading').classList.add('hidden')
      el('error').classList.remove('hidden')
      el('error').textContent = message
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initCarousel)
  </script>
</body>
</html>
